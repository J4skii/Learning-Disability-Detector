<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Comprehension Test - LD Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .question-card {
        display: none;
      }
      .question-card.active {
        display: block;
      }
      .progress-track {
        height: 10px;
      }
      .progress-fill {
        height: 10px;
        transition: width 0.2s ease;
      }
    </style>
  </head>
  <body
    class="font-sans bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-white min-h-screen flex items-center justify-center"
  >
    <div class="max-w-2xl w-full p-6">
      <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 space-y-6"
      >
        <!-- Title -->
        <h1
          class="text-2xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400"
        >
          ðŸ“– Comprehension Quiz
        </h1>

        <!-- Intro block (dynamic counts) -->
        <section
          class="rounded-xl border border-gray-200 dark:border-gray-700 p-4 bg-gray-50 dark:bg-gray-900"
        >
          <h2 class="font-semibold mb-2">What to expect</h2>
          <ul
            class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-300"
          >
            <li>
              Youâ€™ll answer <strong>{{ questions|length }}</strong> questions in
              this attempt.
            </li>
            <li>
              Each question is <strong>multiple choice</strong> with
              <strong>one correct answer</strong> (aâ€“d).
            </li>
            <li>
              The set is <strong>randomly selected</strong> and the answer
              options are shuffled. Not all questions appear every time.
            </li>
            <li>
              Content is drawn from three short passages:
              <ul class="list-disc pl-5 mt-1">
                <li>
                  <em>The Procrastination Puzzle</em> (emotion-driven delay,
                  habit loops, practical starters)
                </li>
                <li>
                  <em>Perfectionism as Hidden Procrastination</em> (fear
                  management, looping edits, reframing success)
                </li>
                <li>
                  <em>The Multitasking Myth</em> (task-switching costs, novelty
                  rewards, focus strategies)
                </li>
              </ul>
            </li>
            <li>
              You can move back and forth. Your score is the number of correct
              answers.
            </li>
          </ul>
          <p class="text-xs text-gray-600 dark:text-gray-400 mt-3">
            Tip: choose the best answer based on the passage ideas, not personal
            opinion.
          </p>
        </section>

        <!-- Progress -->
        <div>
          <div class="flex justify-between items-center text-sm mb-2">
            <span id="progressLabel">Question 1 of {{ questions|length }}</span>
            <span id="progressPct">0%</span>
          </div>
          <div
            class="w-full bg-gray-200 dark:bg-gray-700 rounded-full progress-track"
          >
            <div
              id="progressBar"
              class="bg-blue-600 rounded-full progress-fill"
              style="width: 0%"
            ></div>
          </div>
        </div>

        <form
          method="POST"
          action="{{ url_for('test_comprehension') }}"
          id="quizForm"
        >
          <input
            type="hidden"
            name="name"
            value="{{ session.get('user_name', '') }}"
          />
          <input
            type="hidden"
            name="email"
            value="{{ user.email if user else '' }}"
          />

          {% for q in questions %}
          <input type="hidden" name="q_ids" value="{{ q.id }}" />
          <div
            class="question-card {% if loop.first %}active{% endif %}"
            id="q{{ q.id }}"
          >
            <p class="font-semibold text-gray-800 dark:text-gray-200 mb-4">
              {{ loop.index }}. {{ q.text }}
            </p>
            <div class="space-y-3">
              {% for key, text in q.options_shuffled %}
              <label
                class="block p-3 border border-gray-200 dark:border-gray-700 rounded-xl hover:bg-blue-50 dark:hover:bg-gray-700 cursor-pointer"
              >
                <input
                  type="radio"
                  name="q{{ q.id }}"
                  value="{{ key }}"
                  class="mr-2"
                />
                {{ key }}) {{ text }}
              </label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}

          <!-- Nav buttons -->
          <div class="flex justify-between items-center mt-6">
            <button
              type="button"
              id="prevBtn"
              class="hidden px-5 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg"
            >
              â¬… Previous
            </button>
            <button
              type="button"
              id="nextBtn"
              class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
            >
              Next âž¡
            </button>
            <button
              type="submit"
              id="submitBtn"
              class="hidden px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg"
            >
              âœ… Submit Answers
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const cards = document.querySelectorAll(".question-card");
      let current = 0;

      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const submitBtn = document.getElementById("submitBtn");
      const progressBar = document.getElementById("progressBar");
      const progressLabel = document.getElementById("progressLabel");
      const progressPct = document.getElementById("progressPct");

      function visibleCard(index) {
        cards.forEach((c, i) => c.classList.toggle("active", i === index));
      }

      function updateButtons(index) {
        prevBtn.style.display = index > 0 ? "inline-block" : "none";
        nextBtn.style.display =
          index < cards.length - 1 ? "inline-block" : "none";
        submitBtn.style.display =
          index === cards.length - 1 ? "inline-block" : "none";
      }

      function updateProgress(index) {
        const total = cards.length;
        const pct = Math.round((index / total) * 100); // before answering current
        progressBar.style.width = Math.max(5, pct) + "%";
        progressLabel.textContent = `Question ${index + 1} of ${total}`;
        progressPct.textContent = `${pct}%`;
      }

      function currentAnswerSelected() {
        const radios = cards[current].querySelectorAll('input[type="radio"]');
        for (const r of radios) if (r.checked) return true;
        return false;
      }

      prevBtn.addEventListener("click", () => {
        if (current > 0) {
          current--;
          visibleCard(current);
          updateButtons(current);
          updateProgress(current);
        }
      });

      nextBtn.addEventListener("click", () => {
        // Require an answer before moving forward
        if (!currentAnswerSelected()) {
          alert("Please choose an answer before continuing.");
          return;
        }
        if (current < cards.length - 1) {
          current++;
          visibleCard(current);
          updateButtons(current);
          updateProgress(current);
        }
      });

      // Initialize
      visibleCard(current);
      updateButtons(current);
      updateProgress(current);
    </script>
  </body>
</html>
